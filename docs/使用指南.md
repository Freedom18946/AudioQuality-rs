# AudioQuality-rs 使用指南

## 快速开始

### 系统要求

- **操作系统**: macOS, Linux, Windows
- **Rust版本**: 1.70.0 或更高版本
- **FFmpeg**: 系统中需要安装FFmpeg或在项目resources目录中提供

### 安装与编译

1. **克隆项目**：
```bash
git clone <repository-url>
cd AudioQuality-rs
```

2. **编译项目**：
```bash
# 开发版本
cargo build

# 发布版本（推荐，性能更好）
cargo build --release
```

3. **运行测试**：
```bash
cargo test
```

### 基本使用

#### 命令行模式

**直接分析指定文件夹**：
```bash
# 使用开发版本
cargo run -- /path/to/music/folder

# 使用发布版本（推荐）
cargo run --release -- /path/to/music/folder

# 或直接运行编译后的可执行文件
./target/release/AudioQuality-rs /path/to/music/folder
```

**交互模式**：
```bash
# 不提供路径参数，进入交互模式
cargo run --release

# 然后按照提示操作：
# 1. 分析音频文件
# 2. 退出
```

## 详细功能说明

### 支持的音频格式

程序支持以下音频格式：
- **无损格式**: FLAC, ALAC, AIFF, WAV
- **有损格式**: MP3, AAC, OGG, Opus, WMA, M4A

### 分析指标详解

#### 1. 响度范围 (LRA - Loudness Range)
- **单位**: LU (Loudness Units)
- **用途**: 评估音频的动态范围
- **理想值**: 8-12 LU
- **问题指示**:
  - < 3 LU: 严重过度压缩
  - 3-6 LU: 低动态范围
  - > 20 LU: 动态范围过高

#### 2. 峰值电平 (Peak Amplitude)
- **单位**: dB (分贝)
- **用途**: 检测数字削波
- **理想值**: < -6 dB
- **问题指示**:
  - > -0.1 dB: 存在削波风险
  - = 0 dB: 严重削波

#### 3. 高频段能量 (High-Frequency RMS)
- **测量频段**: 16kHz+, 18kHz+, 20kHz+
- **单位**: dB
- **用途**: 检测假无损音频（转码音频）
- **问题指示**:
  - 18kHz+ < -85 dB: 高度疑似假无损
  - 18kHz+ < -80 dB: 疑似处理过的音频

### 质量评分系统

#### 评分构成 (总分100分)
1. **完整性评分** (40分)
   - 基于18kHz以上频段能量 (25分)
   - 基于峰值电平 (15分)

2. **动态范围评分** (30分)
   - 基于LRA响度范围
   - 理想范围8-12 LU获得满分

3. **频谱评分** (30分)
   - 基于16kHz以上频段能量
   - 评估整体频谱完整性

#### 质量状态分类
- **质量良好**: 无明显技术问题
- **数据不完整**: 关键指标缺失
- **可疑(伪造)**: 疑似假无损音频
- **疑似处理**: 可能经过处理的音频
- **已削波**: 存在数字削波
- **严重压缩**: 动态范围极低
- **低动态**: 动态范围偏低

## 输出文件说明

### 1. analysis_data.json
包含所有音频文件的原始技术指标数据。

**示例结构**：
```json
[
  {
    "filePath": "/path/to/audio.flac",
    "fileSizeBytes": 45678901,
    "lra": 8.7,
    "peakAmplitudeDb": -1.2,
    "overallRmsDb": -18.5,
    "rmsDbAbove16k": -45.2,
    "rmsDbAbove18k": -51.3,
    "rmsDbAbove20k": -62.1,
    "processingTimeMs": 3500
  }
]
```

### 2. audio_quality_report.csv
按质量分数排序的详细分析报告。

**包含字段**：
- 质量分、状态、文件路径、备注
- 所有技术指标数据
- 文件大小和处理时间

### 3. 控制台输出
实时显示分析进度和结果摘要：
- 质量状态分布统计
- 前10名文件排名
- 整体统计信息（平均分、最高分、最低分）

## 高级使用技巧

### 1. 性能优化

**并行处理调优**：
```bash
# 设置Rayon线程池大小（可选）
export RAYON_NUM_THREADS=8
cargo run --release -- /path/to/music
```

**大量文件处理**：
- 建议使用发布版本 (`--release`)
- 确保有足够的系统内存
- 考虑分批处理超大音乐库

### 2. 结果分析

**识别问题音频**：
```bash
# 在CSV中筛选低分文件
grep "^[0-6][0-9]," audio_quality_report.csv

# 查找削波音频
grep "已削波" audio_quality_report.csv

# 查找假无损音频
grep "可疑" audio_quality_report.csv
```

**质量分数解读**：
- **90-100分**: 优秀质量，无明显问题
- **80-89分**: 良好质量，可能有轻微问题
- **70-79分**: 中等质量，存在一些问题
- **60-69分**: 较差质量，有明显问题
- **< 60分**: 质量很差，建议重新获取

### 3. 故障排除

**常见问题及解决方案**：

1. **FFmpeg未找到**：
```bash
# 确保FFmpeg在系统PATH中
which ffmpeg

# 或将FFmpeg放在项目resources目录
cp /path/to/ffmpeg AudioQuality-rs/resources/
```

2. **权限问题**：
```bash
# 确保对音频文件有读取权限
chmod +r /path/to/music/*

# 确保对输出目录有写入权限
chmod +w /path/to/output/directory
```

3. **内存不足**：
- 减少并行处理的文件数量
- 分批处理大型音乐库
- 增加系统虚拟内存

4. **处理速度慢**：
- 使用 `--release` 编译优化
- 检查磁盘I/O性能
- 确保FFmpeg版本较新

## 集成使用

### 作为库使用

在 `Cargo.toml` 中添加依赖：
```toml
[dependencies]
AudioQuality-rs = { path = "/path/to/AudioQuality-rs" }
```

**示例代码**：
```rust
use AudioQuality_rs::analyzer::{ffmpeg, scoring::QualityScorer, report::ReportGenerator};
use std::path::Path;

fn analyze_audio_library(music_path: &Path) -> Result<(), Box<dyn std::error::Error>> {
    // 1. 提取技术指标
    let ffmpeg_path = Path::new("ffmpeg");
    let metrics = ffmpeg::process_file(music_path, ffmpeg_path)?;
    
    // 2. 质量评分
    let scorer = QualityScorer::new();
    let analysis = scorer.analyze_file(&metrics);
    
    // 3. 生成报告
    let generator = ReportGenerator::new();
    generator.generate_csv_report(&[analysis], "report.csv")?;
    
    Ok(())
}
```

### 脚本集成

**批处理脚本示例**：
```bash
#!/bin/bash
# 批量分析多个音乐文件夹

MUSIC_DIRS=(
    "/path/to/collection1"
    "/path/to/collection2"
    "/path/to/collection3"
)

for dir in "${MUSIC_DIRS[@]}"; do
    echo "分析目录: $dir"
    ./target/release/AudioQuality-rs "$dir"
    echo "完成: $dir"
    echo "---"
done
```

## 最佳实践

1. **定期质量检查**: 建议定期对音乐库进行质量分析
2. **备份原始文件**: 在进行任何音频处理前备份原始文件
3. **结果存档**: 保存分析报告以便后续比较和追踪
4. **阈值调整**: 根据具体需求调整质量评分阈值
5. **性能监控**: 监控分析过程的资源使用情况
