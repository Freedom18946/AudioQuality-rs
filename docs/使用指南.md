# AudioQuality-rs 使用指南

## 1. 编译与运行

```bash
cargo build --release
cargo run --release -- /path/to/music
```

交互模式：

```bash
cargo run --release
```

## 2. 常用参数

```bash
AudioQuality-rs [PATH] [OPTIONS]
```

- `--ffmpeg-timeout-seconds <N>`：外部命令超时（默认 `90` 秒）
- `--max-ffmpeg-processes <N>`：外部命令最大并发（默认 CPU 核心数）
- `--unsafe-mode`：关闭安全模式（默认开启，不建议）
- `--no-cache`：关闭增量缓存（默认开启）
- `--jsonl`：额外生成 JSONL 报告
- `--sarif`：额外生成 SARIF 报告
- `--profile <pop|broadcast|archive>`：评分档案（默认 `pop`）

## 3. 输出文件

默认：

- `audio_quality_report.csv`
- `analysis_data.json`
- `.audio_quality_cache.json`（缓存开启时）

可选：

- `audio_quality_report.jsonl`（`--jsonl`）
- `audio_quality_report.sarif.json`（`--sarif`）

## 4. 安全模式说明

默认开启，包含：

- 原子写入（避免部分写入损坏）
- 输出路径符号链接拒绝（防止链接覆盖）
- 外部进程超时终止
- 外部进程总并发限流

## 5. 增量缓存说明

缓存文件：`.audio_quality_cache.json`

命中条件：

- 文件路径（规范化）
- `mtime_unix_secs`
- `file_size_bytes`
- `content_sha256`

命中后该文件会被跳过重分析，输出中 `cacheHit=true`。

## 6. 状态与分数解读

状态枚举见 `docs/SCORING_LOGIC.md`，重点关注：

- `可疑 (伪造)`：无损判定 + 高频能量异常
- `真峰值风险` / `已削波`：基于 true peak
- `响度偏离目标`：基于 integrated loudness 与 profile 目标
- `低码率` / `低采样率` / `单声道`：来自 ffprobe 元数据
- `数据不完整`：关键指标缺失过多

建议优先排查 `errorCodes` 字段（例如 `E_TIMEOUT`、`E_PARSE_*`）。

## 7. 故障排查

### 未找到 ffmpeg

优先从 PATH 查找，不存在时尝试 `resources/ffmpeg`。

### 未找到 ffprobe

程序会继续运行，但采样率/码率/声道等字段可能为空。

### 处理失败或超时

- 适当提高 `--ffmpeg-timeout-seconds`
- 降低 `--max-ffmpeg-processes`
- 检查损坏音频文件
