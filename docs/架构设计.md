# AudioQuality-rs 架构设计（当前实现）

## 模块结构

```text
src/
├── main.rs
└── analyzer/
    ├── mod.rs
    ├── metrics.rs
    ├── ffmpeg.rs
    ├── scoring.rs
    ├── report.rs
    ├── cache.rs
    └── safe_io.rs
```

## 数据流

1. 扫描目录并筛选音频文件
2. 为每个文件生成指纹（mtime + size + sha256）
3. 缓存命中则直接复用 `FileMetrics`
4. 缓存未命中则执行 `ffmpeg/ffprobe` 提取指标
5. 评分模块生成 `QualityAnalysis`
6. 报告模块输出 CSV/JSON，按需输出 JSONL/SARIF
7. 更新 `.audio_quality_cache.json`

## 关键设计点

### 1) 安全输出

- 所有报告写入走 `safe_io::atomic_write_*`
- 默认拒绝输出到符号链接路径
- 防止“预置软链 -> 覆盖外部文件”风险

### 2) 外部命令保护

- `ProcessLimiter` 限制全局并发外部进程数
- 每个命令受 `command_timeout` 约束
- 超时主动终止并记录错误码

### 3) 观测与审计

- `FileMetrics.errorCodes` 保留处理失败原因
- `cacheHit`、`contentSha256` 用于追踪结果来源与一致性

### 4) 可集成输出

- CSV 适合人工审阅
- JSON/JSONL 适合二次处理
- SARIF 适合安全/质量流水线
