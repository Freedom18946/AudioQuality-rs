# AudioQuality-rs 架构设计文档

## 项目概述

AudioQuality-rs 是一个高性能的音频质量分析工具，使用纯 Rust 编写。该项目通过并行调用 FFmpeg 来提取音频技术指标，并使用先进的评分算法对音频质量进行综合评估。

## 核心架构

### 模块化设计

项目采用模块化架构，主要包含以下核心模块：

```
src/
├── main.rs              # 程序入口点和CLI处理
└── analyzer/            # 核心分析模块
    ├── mod.rs          # 模块声明
    ├── ffmpeg.rs       # FFmpeg交互逻辑
    ├── metrics.rs      # 数据结构定义
    ├── scoring.rs      # 质量评分算法
    └── report.rs       # 报告生成功能
```

### 数据流架构

```
音频文件输入
    ↓
文件扫描与过滤
    ↓
并行FFmpeg分析 (提取原始指标)
    ↓
质量评分计算 (综合评估)
    ↓
报告生成 (CSV + 控制台显示)
    ↓
结果输出
```

## 核心组件详解

### 1. FFmpeg 交互层 (`ffmpeg.rs`)

**职责**：
- 管理 FFmpeg 进程的创建和执行
- 解析 FFmpeg 输出并提取技术指标
- 实现并行处理以提高性能

**关键功能**：
- `get_lra_ebur128()`: 使用 EBU R128 标准提取响度范围
- `get_stats_ffmpeg()`: 提取峰值和RMS电平
- `get_highpass_rms_ffmpeg()`: 提取高频段能量（用于假无损检测）

**并行策略**：
使用 `rayon::join` 实现多个独立 FFmpeg 任务的并行执行，显著提升处理速度。

### 2. 数据结构层 (`metrics.rs`)

**核心结构**：
- `FileMetrics`: 存储单个音频文件的所有技术指标
- `AudioStats`: 临时存储峰值和RMS数据的辅助结构

**设计特点**：
- 使用 `Option<f64>` 处理可能缺失的指标
- 支持 JSON 序列化/反序列化
- 字段命名与输出格式严格对应

### 3. 质量评分层 (`scoring.rs`)

**评分体系**：
- **完整性评分** (40分): 基于18kHz以上频段和峰值电平
- **动态范围评分** (30分): 基于LRA响度范围
- **频谱评分** (30分): 基于16kHz以上频段能量

**状态检测**：
- 质量良好、数据不完整、可疑(伪造)
- 疑似处理、已削波、严重压缩、低动态

**阈值配置**：
所有阈值参数与Python参考实现保持一致，确保评分结果的准确性。

### 4. 报告生成层 (`report.rs`)

**功能特性**：
- CSV报告生成（按质量分数排序）
- 控制台摘要显示（状态分布、前10排名、统计信息）
- 支持中文字段名和用户友好的输出格式

## 性能优化策略

### 1. 并行处理

- **FFmpeg并行**: 使用 `rayon::join` 同时执行多个独立的音频分析任务
- **批量评分**: 对大量文件使用并行评分计算
- **CPU利用率**: 充分利用多核CPU资源

### 2. 内存管理

- **流式处理**: 避免同时加载所有文件数据到内存
- **零拷贝**: 尽可能使用引用而非克隆数据
- **及时释放**: 处理完成后立即释放资源

### 3. I/O优化

- **批量写入**: CSV报告使用缓冲写入
- **异步处理**: 文件I/O与计算任务分离
- **路径优化**: 使用高效的路径处理方法

## 错误处理策略

### 1. 分层错误处理

- **FFmpeg错误**: 捕获进程执行失败和输出解析错误
- **文件系统错误**: 处理文件访问权限和路径问题
- **数据验证错误**: 验证音频文件格式和指标有效性

### 2. 容错机制

- **部分失败容忍**: 单个文件分析失败不影响整体流程
- **优雅降级**: 缺失指标时使用默认值或跳过相关计算
- **详细错误报告**: 提供具体的错误信息和建议

## 扩展性设计

### 1. 模块化架构

- **插件化评分**: 可以轻松添加新的评分算法
- **格式扩展**: 支持新的音频格式只需更新文件扩展名列表
- **输出格式**: 可以添加新的报告格式（如JSON、XML等）

### 2. 配置化设计

- **阈值配置**: 所有评分阈值都可以通过配置文件调整
- **并行度控制**: 可以根据系统资源调整并行处理数量
- **输出定制**: 支持自定义输出字段和格式

## 与Python版本的对比

### 优势

1. **性能**: Rust的零成本抽象和并行处理能力
2. **内存安全**: 编译时保证内存安全，避免运行时错误
3. **部署简便**: 单一可执行文件，无需Python环境
4. **资源效率**: 更低的内存占用和CPU使用率

### 兼容性

1. **算法一致**: 评分算法与Python版本完全一致
2. **输出格式**: CSV报告格式保持兼容
3. **阈值参数**: 所有阈值参数值相同

## 未来发展方向

### 1. 功能增强

- **实时分析**: 支持音频流的实时质量监控
- **批量配置**: 支持配置文件批量处理
- **Web界面**: 提供基于Web的用户界面

### 2. 性能优化

- **GPU加速**: 利用GPU进行频谱分析计算
- **缓存机制**: 缓存已分析文件的结果
- **增量分析**: 只分析新增或修改的文件

### 3. 生态集成

- **API服务**: 提供REST API接口
- **数据库集成**: 支持将结果存储到数据库
- **监控集成**: 与监控系统集成，提供质量趋势分析
